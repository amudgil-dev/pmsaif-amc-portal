
{% extends 'navbar.html' %}

{% block content  %}
<script>
  // Main function to initialize everything
  function initStockSelection(config) {
    const {
        stockNameSelector,
        selectedStocksTableSelector,
        addStockButtonSelector,
        formSelector,
        pmsIdSelector,
        errorMessageSelector,
        autocompleteUrl,
        submitUrl
    } = config;

    let selectedStockIds = new Set(
        Array.from(document.querySelectorAll(selectedStocksTableSelector + " tbody tr"))
            .map(row => row.getAttribute('data-stock-id'))
    );

    console.log("Initial selectedStockIds:", Array.from(selectedStockIds));

    initAutocomplete(stockNameSelector, autocompleteUrl, selectedStockIds, errorMessageSelector);
    initDeleteStock(selectedStocksTableSelector, selectedStockIds);
    initAddStock(addStockButtonSelector, stockNameSelector);
    initFormSubmission(formSelector, selectedStocksTableSelector, pmsIdSelector, errorMessageSelector, submitUrl);
}


function initAutocomplete(selector, url, selectedStockIds, errorMessageSelector) {
    $(selector).autocomplete({
        source: (request, response) => {
            $.ajax({
                url: url,
                dataType: 'json',
                data: { query: request.term },
                success: (data) => response(data)
            });
        },
        minLength: 3,
        select: (event, ui) => handleStockSelection(event, ui, selectedStockIds, errorMessageSelector, selector)
    }).autocomplete("instance")._renderItem = (ul, item) => {
        return $("<li>").append("<div>" + item.label + "</div>").appendTo(ul);
    };
}

function handleStockSelection(event, ui, selectedStockIds,errorMessageSelector) {
    const stockEntry = $(event.target).closest('.stock-entry');
    const stockId = String(ui.item.value).trim();

    console.log('In handleStockSelection() - stockId:', stockId);
    console.log('Current selectedStockIds:', Array.from(selectedStockIds));

    let isDuplicate = false;
    for (let existingId of selectedStockIds) {
        console.log(`Comparing - Existing: "${existingId}" (${typeof existingId}), New: "${stockId}" (${typeof stockId})`);
        if (String(existingId).trim().toLowerCase() === stockId.toLowerCase()) {
            isDuplicate = true;
            break;
        }
    }

    if (!isDuplicate) {
        console.log('Not a duplicate, adding to table and set');
        addStockToTable(ui.item, stockId);
        selectedStockIds.add(stockId);
        clearAndFocusInput(stockEntry);
        $(errorMessageSelector).text(''); // Clear any existing error message

    } else {
        console.log("This stock is already selected.");
        // alert("This stock is already selected.");
        $(errorMessageSelector).text("This stock is already selected.");
        $(event.target).val(''); // Clear the input box that triggered this event        
    }

    return false;
}

function addStockToTable(item, stockId) {

 
    $("#selectedStocks tbody").append(`
        <tr data-stock-id='${stockId}'>
            <td>${item.name}</td>
            <td>${item.stock_symbol}</td>
            <td>${item.isin}</td>
            <td><input type='number' class='quantity-input' value='' min='0' step='any'></td>
            <td><button class='delete-stock'>X</button></td>
        </tr>
    `);
}

function clearAndFocusInput(stockEntry) {
    stockEntry.find('.stock-name').val('');
    stockEntry.find('.quantity-input').last().focus();
}

function initDeleteStock(tableSelector, selectedStockIds) {
    $(document).on('click', '.delete-stock', function() {
        const stockIdToRemove = $(this).closest('tr').data('stock-id');
        $(this).closest('tr').remove();
        selectedStockIds.delete(stockIdToRemove);
    });
}

function initAddStock(buttonSelector, stockEntrySelector) {
    
    $(buttonSelector).on('click', function() {
        const newStockEntry = $(stockEntrySelector).first().clone();
        newStockEntry.find('input').val('');
        $("#stockForm").append(newStockEntry);
    });
}

function initFormSubmission(formSelector, tableSelector, pmsIdSelector, errorMessageSelector, submitUrl) {
    $(formSelector).submit(function(event) {
        event.preventDefault();

        const selectedStockData = getSelectedStockData(tableSelector);

        const pmsId = $(pmsIdSelector).val();

        if (validateTotalHolding(errorMessageSelector)) {
            submitStockData(selectedStockData, pmsId, submitUrl);
        }
    });
}


function getSelectedStockData(tableSelector) {
    console.log('getSelectedStockData() ' + tableSelector);
    
    const selectedStocks = [];
    const rows = document.querySelectorAll(tableSelector + " tbody tr");

    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const stockId = row.getAttribute('data-stock-id');
        const quantityInput = row.querySelector('.quantity-input');
        const quantity = quantityInput ? quantityInput.value : '';

        selectedStocks.push({
            stockId: stockId,
            quantity: quantity
        });
    }

    console.log("Selected stocks:", selectedStocks); // For debugging
    return selectedStocks;
}

function validateTotalHolding(errorMessageSelector) {
    const total = Array.from($('.quantity-input')).reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);
    if (total > 100) {
        $(errorMessageSelector).text('The total holding percentage exceeds 100. Please adjust the values.');
        return false;
    }
    return true;
}

function submitStockData(selectedStockData, pmsId, submitUrl) {
    $.ajax({
        type: 'POST',
        url: submitUrl,
        contentType: 'application/json',
        data: JSON.stringify({ selectedStockData, pms_id: pmsId }),
        headers: { 'X-CSRFToken': $('input[name=csrf_token]').val() },
        success: (response) => {
            console.log("Selection submitted successfully:", response);
            window.location.href = "/pmsdash/" + pmsId;
        },
        error: (jqXHR, textStatus, errorThrown) => {
            console.error("Error submitting selection:", jqXHR.responseText);
        }
    });
}

// Usage
$(function() {
    initStockSelection({
        stockNameSelector: ".stock-name",
        selectedStocksTableSelector: "#selectedStocks",
        addStockButtonSelector: "#addStock",
        formSelector: "#stockForm",
        pmsIdSelector: "#pms_id",
        errorMessageSelector: "#error-message",
        autocompleteUrl: '/autocompstock',
        submitUrl: '/selectedstocks'
    });
});
</script>


<div class="container">
    <div class="row">
      <div class="col-sm-12 m-auto">

            {% for category, message in get_flashed_messages(with_categories=True) %}
                <div class="alert alert-{{category}} alert-dismissible">
                    <strong>{{ message }}</strong>
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span>&times;</span></button>
                </div>

            {% endfor %}

                <!-- <h1>Login  </h1> -->
                <br/>


            <form method="POST" action="/" id="stockForm">
                {{ form.csrf_token }}
                <input id="pms_id" name="pms_id" type="hidden" value="{{pms.pms_id}}">

                <div class="stock-entry">
                    <label for="stock_name"><h3>Type three or more characters to find stock</h3></label>
                    <br>
                    <input type="text" class="stock-name" name="stock_name[]" autocomplete="off"> 
                    <div class="autocomplete-results"></div>     

                    <br><br>
                    
            
                    <input type="hidden" class="stock-id" name="stock_id[]">
            

                </div>
                <section id="selectedStocks">
                    <div class="container">
                      <div class="row">
                        <div class="col-md-9">
                          <div class="card">
                            <div class="card-header">

                            </div>
                            <table class="table table-striped">
                              <thead class="thead-dark">
                                <tr>

                                  <th>Company</th>
                                  <th>Symbol</th>
                                  <th>ISIN</th>                                                                    
                                  <th> Holding %</th>
                                  <th>Remove</th>
                                </tr>
                              </thead>
                              <tbody>
                                {% for stock in pms_stocks %}
                                <tr data-stock-id=" {{stock.stock_id}} ">
 
                                  <td>{{stock.stock_name}}</td>
                                  <td>{{stock.stock_symbol}}</td>
                                  <td>{{stock.isin_code}}</td>
                                  <td><input type='float' class='quantity-input' value='{{stock.pct_deployed}}' min="0" step="any"></td>

                                  <td>
                                    <button class='delete-stock'>X</button>
                                  </td>
                                </tr>
                              
                                {% endfor %}
                
                              </tbody>
                            </table>
                          </div>
                        </div>
                      
                       
                
                      </div>
                    </div>
                  </section>
              <!-- Error message container -->
                <div id="error-message" style="color: red; margin-top: 20px;"></div>
      

                  <br>
                  <button type="submit" onClick="check100Bounds(this)">Submit</button>
                  <!-- <button type="submit" class="btn btn-primary">Submit</button> -->
              
              </form>                            
     
   
                
                <!-- ... (remaining HTML code) ... -->

        </div>
    </div>
</div>   

{% endblock %}

             <!-- ... (previous HTML and script tags) ... -->
                
 