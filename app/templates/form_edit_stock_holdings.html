
{% extends 'navbar.html' %}

{% block content  %}
<script>
    $(function() {
        // Maintain a set to track selected stock IDs
        var selectedStockIds = new Set();

        // Attach autocomplete to the stock_name input fields
        $(".stock-name").autocomplete({
            source: function(request, response) {
                $.ajax({
                    url: '/autocompstock',
                    dataType: 'json',
                    data: {
                        query: request.term
                    },
                    success: function(data) {
                        response(data);
                    }
                });
            },
            minLength: 3, // Minimum characters to trigger autocomplete
            select: function(event, ui) {
                // Update the additional fields when an option is selected
                var stockEntry = $(this).closest('.stock-entry');
                var stockId = ui.item.value;

                // Check if the stock with the same ID is already selected
                if (!selectedStockIds.has(stockId)) {
                    stockEntry.find('.stock-name').val(ui.item.name);
                    stockEntry.find('.stock-id').val(stockId);

                    // Display the selected stock in the table
                    var selectedStocksTable = $("#selectedStocks tbody");
                    selectedStocksTable.append("<tr data-stock-id='" + stockId + "'>" +
                        "<td>" + ui.item.name + "</td>" +
                        "<td>" + ui.item.stock_symbol + "</td>" +
                        "<td>" + ui.item.isin + "</td>" +
                        "<td><input type='float' class='quantity-input' value='' min='0' step='any' ></td>" +
                        "<td><button class='delete-stock'>X</button></td>" +
                        "</tr>");

                    // Add the stock ID to the set
                    selectedStockIds.add(stockId);

                    // Clear the stock_name field
                    $(this).val('');

                    // Focus on the quantity input field
                    stockEntry.find('.quantity-input').last().focus();
                } else {
                    alert("This stock is already selected.");
                }

                return false; // Prevent the default select behavior
            }
        }).autocomplete("instance")._renderItem = function(ul, item) {
            // Customize the display of each autocomplete item (optional)
            return $("<li>")
                .append("<div>" + item.label + "</div>")
                .appendTo(ul);
        };

        // Handle delete button click for dynamically added stocks
        $(document).on('click', '.delete-stock', function() {
            var stockIdToRemove = $(this).closest('tr').data('stock-id');
            //alert(' to be removed '+stockIdToRemove);

            // Remove the stock from the table
            $(this).closest('tr').remove();

            // Remove the stock ID from the set
            selectedStockIds.delete(stockIdToRemove);
        });

        // Handle "Add Another Stock" button click
        $("#addStock").on('click', function() {
            // Clone the first stock entry and append it to the form
            var newStockEntry = $(".stock-entry:first").clone();
            newStockEntry.find('input').val(''); // Clear input values in the cloned entry
            $("#stockForm").append(newStockEntry);
        });

        // Handle form submission
        $("#stockForm").submit(function(event) {

            // Add logic to handle form submission
            event.preventDefault(); // Prevent the default form submission

            // Create an array to store selected stock data
            var selectedStockData = [];

            // Iterate over each selected stock in the table
            $("#selectedStocks tbody tr").each(function() {
                var stockId = $(this).data('stock-id');
                var quantity = $(this).find('.quantity-input').val();

                // Add the stock ID and quantity to the array
                selectedStockData.push({
                    stockId: stockId,
                    quantity: quantity
                });
            });

            

            // Log all selected stock data to the console
            console.log("Selected Stock Data:", selectedStockData);

            // Get values of additional hidden fields
                 
             var pms_id = $("#pms_id").val()
            //alert(pms_id);
            
            var total = 0;
            $('.quantity-input').each(function() {
                total += parseFloat($(this).val()) || 0;
            });
            if (total > 100) {
                // alert('The total holding percentage exceeds 100. Please adjust the values.');
                $('#error-message').text('The total holding percentage exceeds 100. Please adjust the values.');
                // return false;  // Prevent form submission
                return false;
            } else {
                // alert('Form submitted successfully! Total holding percentage: ' + total);
                // return true;  // Allow form submission
            }

            

            // Submit selected stock data and additional fields to the endpoint /selectedstocks
            $.ajax({
                type: 'POST',
                url: '/selectedstocks',
                contentType: 'application/json',
                data: JSON.stringify({
                    selectedStockData: selectedStockData,
                    pms_id: pms_id
                }),
                headers: {
                    'X-CSRFToken': $('input[name=csrf_token]').val()
                },   
                success: function(response) {
                    console.log("Selection submitted successfully:", response);
                    window.location.href = "/pmsdash/" + pms_id;
                    // alert(' redirecting to pms_id ='+pms_id)

                    //top.location.href="login.htm";

                },
                error: function(error) {
                    console.error("Error submitting selection:", error);
                    console.error("Error submitting selection:");
                    console.error("Status:", textStatus);
                    console.error("Error:", errorThrown);
                    console.error("Response Text:", jqXHR.responseText);
                    console.error("Status Code:", jqXHR.status);                         
                }
            });
        });
    });
</script>
<div class="container">
    <div class="row">
      <div class="col-sm-12 m-auto">

            {% for category, message in get_flashed_messages(with_categories=True) %}
                <div class="alert alert-{{category}} alert-dismissible">
                    <strong>{{ message }}</strong>
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span>&times;</span></button>
                </div>

            {% endfor %}

                <!-- <h1>Login  </h1> -->
                <br/>


            <form method="POST" action="/" id="stockForm">
                {{ form.csrf_token }}
                <input id="pms_id" name="pms_id" type="hidden" value="{{pms.pms_id}}">

                <div class="stock-entry">
                    <label for="stock_name"><h3>Type three or more characters to find stock</h3></label>
                    <br>
                    <input type="text" class="stock-name" name="stock_name[]" autocomplete="off"> 
                    <div class="autocomplete-results"></div>     

                    <br><br>
                    
            
                    <input type="hidden" class="stock-id" name="stock_id[]">
            

                </div>
                <section id="selectedStocks">
                    <div class="container">
                      <div class="row">
                        <div class="col-md-9">
                          <div class="card">
                            <div class="card-header">

                            </div>
                            <table class="table table-striped">
                              <thead class="thead-dark">
                                <tr>

                                  <th>Company</th>
                                  <th>Symbol</th>
                                  <th>ISIN</th>                                                                    
                                  <th> Holding %</th>
                                  <th>Remove</th>
                                </tr>
                              </thead>
                              <tbody>
                                {% for stock in pms_stocks %}
                                <tr data-stock-id=" {{stock.stock_id}} ">
 
                                  <td>{{stock.stock_name}}</td>
                                  <td>{{stock.stock_symbol}}</td>
                                  <td>{{stock.isin_code}}</td>
                                  <td><input type='float' class='quantity-input' value='{{stock.pct_deployed}}' min="0" step="any"></td>

                                  <td>
                                    <button class='delete-stock'>X</button>
                                  </td>
                                </tr>
                              
                                {% endfor %}
                
                              </tbody>
                            </table>
                          </div>
                        </div>
                      
                       
                
                      </div>
                    </div>
                  </section>
              <!-- Error message container -->
                <div id="error-message" style="color: red; margin-top: 20px;"></div>
      

                  <br>
                  <button type="submit" onClick="check100Bounds(this)">Submit</button>
                  <!-- <button type="submit" class="btn btn-primary">Submit</button> -->
              
              </form>                            
     
   
                
                <!-- ... (remaining HTML code) ... -->

        </div>
    </div>
</div>   

{% endblock %}

             <!-- ... (previous HTML and script tags) ... -->
                
 