
{% extends 'navbar.html' %}

{% block content  %}

<script>
    // Main function to initialize everything
function initSectorSelection(config) {
    const {
        sectorNameSelector,
        selectedSectorsTableSelector,
        formSelector,
        pmsIdSelector,
        errorMessageSelector,
        autocompleteUrl,
        submitUrl
    } = config;

    let selectedSectorIds = new Set(
        Array.from(document.querySelectorAll(selectedSectorsTableSelector + " tbody tr"))
            .map(row => row.getAttribute('data-sector-id').trim())
    );

    console.log("Initial selectedSectorIds:", Array.from(selectedSectorIds));

    initAutocomplete(sectorNameSelector, autocompleteUrl, selectedSectorIds, errorMessageSelector);
    initDeleteSector(selectedSectorsTableSelector, selectedSectorIds);
    initFormSubmission(formSelector, selectedSectorsTableSelector, pmsIdSelector, errorMessageSelector, submitUrl);
}

function initAutocomplete(selector, url, selectedSectorIds, errorMessageSelector) {
    $(selector).autocomplete({
        source: (request, response) => {
            $.ajax({
                url: url,
                dataType: 'json',
                data: { query: request.term },
                success: (data) => response(data)
            });
        },
        minLength: 3,
        select: (event, ui) => handleSectorSelection(event, ui, selectedSectorIds, errorMessageSelector)
    }).autocomplete("instance")._renderItem = (ul, item) => {
        return $("<li>").append("<div>" + item.label + "</div>").appendTo(ul);
    };
}

function handleSectorSelection(event, ui, selectedSectorIds, errorMessageSelector) {
    const sectorEntry = $(event.target).closest('.sector-entry');
    const sectorId = String(ui.item.value).trim();

    console.log('In handleSectorSelection() - sectorId:', sectorId);
    console.log('Current selectedSectorIds:', Array.from(selectedSectorIds));

    if (!selectedSectorIds.has(sectorId)) {
        console.log('Not a duplicate, adding to table and set');
        addSectorToTable(ui.item, sectorId);
        selectedSectorIds.add(sectorId);
        clearAndFocusInput(sectorEntry);
        $(errorMessageSelector).text(''); // Clear any existing error message
    } else {
        console.log("This sector is already selected.");
        $(errorMessageSelector).text("This sector is already selected.");
        $(event.target).val(''); // Clear the input box that triggered this event        
    }

    return false;
}

function addSectorToTable(item, sectorId) {
    $("#selectedSectors tbody").append(`
        <tr data-sector-id='${sectorId}'>
            <td>${item.name}</td>
            <td><input type='number' class='quantity-input' value='' min='0' step='any'></td>
            <td><button class='delete-sector'>X</button></td>
        </tr>
    `);
}

function clearAndFocusInput(sectorEntry) {
    sectorEntry.find('.sector-name').val('');
    sectorEntry.find('.quantity-input').last().focus();
}

function initDeleteSector(tableSelector, selectedSectorIds) {
    $(document).on('click', '.delete-sector', function() {
        const sectorIdToRemove = $(this).closest('tr').data('sector-id');
        $(this).closest('tr').remove();
        selectedSectorIds.delete(sectorIdToRemove);
    });
}

function initFormSubmission(formSelector, tableSelector, pmsIdSelector, errorMessageSelector, submitUrl) {
    $(formSelector).submit(function(event) {
        event.preventDefault();

        const selectedSectorData = getSelectedSectorData(tableSelector);
        const pmsId = $(pmsIdSelector).val();

        if (validateTotalHolding(errorMessageSelector)) {
            submitSectorData(selectedSectorData, pmsId, submitUrl);
        }
    });
}

function getSelectedSectorData(tableSelector) {
    console.log('getSelectedSectorData() ' + tableSelector);
    
    const selectedSectors = [];
    const rows = document.querySelectorAll(tableSelector + " tbody tr");

    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const sectorId = row.getAttribute('data-sector-id');
        const quantityInput = row.querySelector('.quantity-input');
        const quantity = quantityInput ? quantityInput.value : '';

        selectedSectors.push({
            sectorId: sectorId,
            quantity: quantity
        });
    }

    console.log("Selected sectors:", selectedSectors); // For debugging
    return selectedSectors;
}

function validateTotalHolding(errorMessageSelector) {
    const total = Array.from($('.quantity-input')).reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);
    if (total > 100) {
        $(errorMessageSelector).text('The total holding percentage exceeds 100. Please adjust the values.');
        return false;
    }
    return true;
}

function submitSectorData(selectedSectorData, pmsId, submitUrl) {
    $.ajax({
        type: 'POST',
        url: submitUrl,
        contentType: 'application/json',
        data: JSON.stringify({ selectedSectorData, pms_id: pmsId }),
        headers: { 'X-CSRFToken': $('input[name=csrf_token]').val() },
        success: (response) => {
            console.log("Selection submitted successfully:", response);
            window.location.href = "/pmsdash/" + pmsId;
        },
        error: (jqXHR, textStatus, errorThrown) => {
            console.error("Error submitting selection:", jqXHR.responseText);
        }
    });
}

// Usage
$(function() {
    initSectorSelection({
        sectorNameSelector: ".sector-name",
        selectedSectorsTableSelector: "#selectedSectors",
        formSelector: "#sectorForm",
        pmsIdSelector: "#pms_id",
        errorMessageSelector: "#error-message",
        autocompleteUrl: '/autocompsector',
        submitUrl: '/selectedsectors'
    });
});
</script>

<div class="container">
    <div class="row">
      <div class="col-sm-12 m-auto">

            {% for category, message in get_flashed_messages(with_categories=True) %}
                <div class="alert alert-{{category}} alert-dismissible">
                    <strong>{{ message }}</strong>
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span>&times;</span></button>
                </div>

            {% endfor %}

                <!-- <h1>Login  </h1> -->
                <br/>


            <form method="POST" action="/selectedsectors" id="sectorForm">
                {{ form.csrf_token }}
                <input id="pms_id" name="pms_id" type="hidden" value="{{pms.pms_id}}">

                <div class="sector-entry">
                    <label for="sector_name"><h3>Type three or more characters to find sector</h3></label>
                    <br>
                    <input type="text" class="sector-name" name="sector_name[]" autocomplete="off"> 
                    <div class="autocomplete-results"></div>     

                    <br><br>
                    
            
                    <input type="hidden" class="sector-id" name="sector_id[]">
            

                </div>
                <section id="selectedSectors">
                    <div class="container">
                      <div class="row">
                        <div class="col-md-9">
                          <div class="card">
                            <div class="card-header">

                            </div>
                            <table class="table table-striped">
                              <thead class="thead-dark">
                                <tr>

                                  <th>Company</th>
                                  <th>Holding %</th>

                                  <th>Remove</th>
                                </tr>
                              </thead>
                              <tbody>
                                {% for sector in pms_sectors %}
                                <tr data-sector-id=" {{sector.sector_id}} ">
 
                                  <td>{{sector.sector_name}}</td>

                                  <td><input type='float' class='quantity-input' value='{{sector.pct_deployed}}' min="0" step="any"></td>

                                  <td>
                                    <button class='delete-sector'>X</button>
                                  </td>
                                </tr>
                              
                                {% endfor %}
                
                              </tbody>
                            </table>
                          </div>
                        </div>
                      
                       
                
                      </div>
                    </div>
                  </section>

                 <br>
                <!-- Error message container -->
                <div id="error-message" style="color: red; margin-top: 20px;"></div>
                  <br>
                  <button type="submit">Submit</button>
              
              </form>                            
     
   
                
                <!-- ... (remaining HTML code) ... -->

        </div>
    </div>
</div>   
{% endblock %}

             <!-- ... (previous HTML and script tags) ... -->
                
 